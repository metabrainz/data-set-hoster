{% macro link_mb(entity, value) %}
  {% if value %}
    <a href="https://musicbrainz.org/{{ entity }}/{{ value }}"
       target="_blank" rel="noopener noreferrer">
      {{ value }}
    </a>
  {% else %}
    {{ value }}
  {% endif %}
{% endmacro %}

{% macro format_output(output, additional_data) %}
  {% if output %}
    {% if "recording_mbid" in output.columns %}
      {% set recording_mbids = output.data[:50] | selectattr('recording_mbid') | join(',', 'recording_mbid') %}
      {% if recording_mbids %}
        <div style="float: right">
          <a class="button"
             target="_blank"
             rel="noopener noreferrer"
             href="https://listenbrainz.org/player/?recording_mbids={{ recording_mbids }}&desc={{ additional_data['playlist_desc'] | urlencode }}&name={{ additional_data['playlist_name'] | urlencode }}">
            Open results as a playlist
          </a>
        </div>
      {% endif %}
    {% endif %}
    <div>
      {% set count = output.data | length %}
      {% if count %}
        <p><b>{{ count }} rows returned</b></p>
      {% else %}
        <p><b>No results found</b></p>
      {% endif %}
    </div>
    <table>
      <thead>
      <tr>
        {% for column in output.columns %}
          <th>{{ column }}</th>
        {% endfor %}
      </tr>
      </thead>
      <tbody>
      {% for row in output.data %}
        <tr>
          {% for column in output.columns %}
            {% if column.endswith("recording_mbid") or column.endswith("recording_id") %}
              <td>{{ link_mb('recording', row[column]) }}</td>
            {% elif column.endswith("release_mbid") or column.endswith("release_id") %}
              <td>{{ link_mb('release', row[column]) }}</td>
            {% elif column.endswith("release_group_mbid") or column.endswith("release_group_id") %}
              <td>{{ link_mb('release-group', row[column]) }}</td>
            {% elif column.endswith("artist_mbid") %}
              <td>{{ link_mb('artist', row[column]) }}</td>
            {% elif column.endswith("[artist_credit_mbids]") and row[column] is iterable %}
              <td>
                {% for v in row[column] %}
                  {{ link_mb('artist', v) }}
                {% endfor %}
              </td>
            {% elif column.endswith("_json") %}
              <td>
                <pre>{{ row[column] }}</pre>
              </td>
            {% elif row[column] is iterable and row[column] is not string %}
              <td>
                {% for v in row[column] %}
                  {{ v }}
                {% endfor %}
              </td>
            {% else %}
              <td>{{ row[column] }}</td>
            {% endif %}
          {% endfor %}
        </tr>
      {% endfor %}
      </tbody>
    </table>
  {% endif %}
{% endmacro %}
